# ðŸª³ Ciroach Milestone: 2026-01-29

**Focus:** Parallelize image pre-pulling to minimize "Cold Start" latency and maximize network throughput.

## 1. Dependency Management (`Cargo.toml`)

To handle multiple futures concurrently without manual polling logic, we need the `futures-util` crate.

- Add `futures-util` to dependencies.
- Utilize `try_join_all` for atomic success (if one pull fails, the whole set fails).

## 2. Image Set Deduplication (`PipelineRunner`)

We must avoid redundant pulls for steps sharing the same image.

- **Unique Extraction:** Ensure `HashSet<String>` is used to extract unique image tags from the Stage.
- **Log Management:** Consolidate pull logs so the console isn't flooded with identical "Pulling alpine..." messages.

## 3. Parallel Orchestration (`pre_pull_images`)

The core logic shifts from a sequential `for` loop to a vector of futures.

- **Task Mapping:** Map the set of unique images to `engine.pull_image` futures.
- **Concurrent Await:** Execute all tasks simultaneously using `try_join_all`.
- **Fail-Fast:** If a specific image fails (e.g., Authentication Required or 404), the `PipelineRunner` should catch the error immediately and halt before any containers are created.

## 4. Resource Guarding (Docker Daemon)

Parallel pulls increase the load on the Docker daemon.

- **Layer Locking:** Observe how the daemon handles parallel pulls of different images sharing the same base layers.
- **Error Handling:** Ensure that `anyhow::Result` correctly propagates errors from the background pull tasks back to the main loop.

## Testing Scenarios

1. **The Shared Base:** A stage with `node:20-alpine`, `python:3-alpine`, and `alpine:latest`. All three share the Alpine base layer; parallel pulling should be handled efficiently by the Docker engine.
2. **The Heavy Download:** Use multiple large images (e.g., `rust:latest`, `golang:latest`, `postgres:latest`) and compare the total "Stage Start" time against the previous sequential version.
3. **The Network Interruption:** Simulate a network failure during a parallel pull to verify that the pipeline doesn't attempt to start steps with partially downloaded images.
