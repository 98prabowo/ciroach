# ciroach pipeline.toml - Engine Stress Test

stages_order = ["Sanity", "Main Execution", "Finalize"]

[stages.Sanity]
[stages.Sanity.steps.warmup]
image = "alpine:latest"
command = "echo 'Warming up...' && sleep 2"

[stages."Main Execution"]
# 1. Tests Matrix + Parallelism
[stages."Main Execution".steps.build]
image = "alpine:latest"
command = "echo 'Building for arch: ${{ arch }}' && sleep 2"
matrix = { variable = "arch", values = ["x86", "arm64", "wasm"] }

# 2. Tests Dependency DAG (Wait for all 3 matrix builds)
[stages."Main Execution".steps.test-suite]
image = "alpine:latest"
command = "echo 'Running tests on all builds...'"
needs = ["build"]

# 3. Tests Retries (Will fail twice, then succeed)
[stages."Main Execution".steps.flaky-service]
image = "alpine:latest"
command = "if [ ! -f /tmp/attempted ]; then touch /tmp/attempted && exit 1; else echo 'Recovered!'; fi"
max_retries = 3

# 4. Tests Timeouts & Zombie Cleanup
# This will run for 10s but timeout at 2s.
# Your engine should kill this container immediately.
[stages."Main Execution".steps.long-task]
image = "alpine:latest"
command = "echo 'Starting long sleep...' && sleep 10"
timeout = "2s"

# 5. Tests Out of Memory (OOM) 
# Assigning a tiny memory limit to trigger your OOM logic
[stages."Main Execution".steps.memory-hog]
image = "polinux/stress"
command = "stress --vm 1 --vm-bytes 100M --timeout 5s"
memory = "10mb"
needs = ["test-suite"]

[stages.Finalize]
[stages.Finalize.steps.cleanup]
image = "alpine:latest"
command = "echo 'Cleaning up artifacts...'"
